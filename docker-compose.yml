# Docker Compose файл для локального запуска сервиса аутентификации
# Использует PostgreSQL как базу данных и FastAPI приложение

version: '3.9'

services:
  # Сервис базы данных PostgreSQL
  db:
    image: postgres:15  # Образ PostgreSQL версии 15
    environment:
      POSTGRES_DB: auth  # Имя базы данных
      POSTGRES_USER: dev  # Пользователь базы данных
      POSTGRES_PASSWORD: devpass  # Пароль пользователя
    ports:
      - "5432:5432"  # Проброс порта 5432 на хост
    volumes:
      - pgdata:/var/lib/postgresql/data  # Том для хранения данных БД

  # Сервис веб-приложения FastAPI
  web:
    build: .  # Сборка образа из Dockerfile в корне проекта
    command: bash -c "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000"  # Команда: применить миграции и запустить сервер
    environment:
      DATABASE_URL: postgresql+asyncpg://dev:devpass@db:5432/auth  # URL для подключения к БД (asyncpg для приложения)
      ALEMBIC_DATABASE_URL: postgresql+psycopg2://dev:devpass@db:5432/auth  # URL для Alembic (psycopg2 для миграций)
      APP_BASE_URL: http://localhost:8000  # Базовый URL приложения
    ports:
      - "8000:8000"  # Проброс порта 8000 на хост
    depends_on:
      - db  # Зависимость от сервиса db
    volumes:
      - ./app:/app/app  # Монтирование исходного кода для разработки
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini

# Определение томов
volumes:
  pgdata:  # Том для данных PostgreSQL
